<!DOCTYPE HTML>
<html lang="en-US" manifest="./manifest.appcache">
    
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        
        <meta charset="UTF-8">
        <title>Partition | Fabric8 Documentation</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="https:">
        <meta name="description" content="Fabric8 User Guide and Reference Documentation">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="./processManager.html" />
        
        
        <link rel="prev" href="./offlineRepo.html" />
        

        <meta property="og:title" content="Partition | Fabric8 Documentation">
        <meta property="og:site_name" content="Fabric8 Documentation">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/https:">
        <meta property="book:tag" content="GitBook">

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
        
    </head>
    <body>
        
        

        <link rel="stylesheet" href="gitbook/style.css">
        


        
    <div class="book" data-github="https://github.com/fabric8io/fabric8" data-level="5.5" data-basepath="." data-revision="1402142872565">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="http://fabric8.io/" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    
    <a href="https://github.com/https://github.com/fabric8io/fabric8/stargazers" target="_blank" class="btn pull-right count-star hidden-xs"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/https://github.com/fabric8io/fabric8/watchers" target="_blank" class="btn pull-right count-watch hidden-xs"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="./" >Fabric8 Documentation</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        <li>
            <a href="https://github.com/fabric8io/fabric8/blob/master/readme.md" target="blank" class="author-link">About the author</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/fabric8io/fabric8/issues?milestone=none&amp;state=closed" target="blank"class="issues-link">Questions and Issues</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/fabric8io/fabric8/blob/master/Contributing.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

        
        <li class="divider"></li>
        

        <li data-level="0" data-path="index.html">
            <a href="./"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
    
        <li class="chapter " data-level="1" data-path="overview.html">
            
            <a href="./overview.html">
                <i class="fa fa-check"></i> <b>1.</b> Introduction
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="overview.html">
            
            <a href="./overview.html">
                <i class="fa fa-check"></i> <b>1.1.</b> Overview
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="getStarted.html">
            
            <a href="./getStarted.html">
                <i class="fa fa-check"></i> <b>1.2.</b> Get Started
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="environmentVariables.html">
            
            <a href="./environmentVariables.html">
                <i class="fa fa-check"></i> <b>1.3.</b> Environment Variables
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="developer.html">
            
            <a href="./developer.html">
                <i class="fa fa-check"></i> <b>2.</b> Developing
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="developer.html">
            
            <a href="./developer.html">
                <i class="fa fa-check"></i> <b>2.1.</b> Developer Workflow
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="mavenPlugin.html">
            
            <a href="./mavenPlugin.html">
                <i class="fa fa-check"></i> <b>2.2.</b> Maven Plugin
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="registry.html">
            
            <a href="./registry.html">
                <i class="fa fa-check"></i> <b>3.</b> Architecture
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="registry.html">
            
            <a href="./registry.html">
                <i class="fa fa-check"></i> <b>3.1.</b> Registry
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="profiles.html">
            
            <a href="./profiles.html">
                <i class="fa fa-check"></i> <b>3.2.</b> Profiles
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="agent.html">
            
            <a href="./agent.html">
                <i class="fa fa-check"></i> <b>3.3.</b> Agent
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="git.html">
            
            <a href="./git.html">
                <i class="fa fa-check"></i> <b>3.4.</b> Git
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="mavenProxy.html">
            
            <a href="./mavenProxy.html">
                <i class="fa fa-check"></i> <b>3.5.</b> Maven Proxy
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="microServices.html">
            
            <a href="./microServices.html">
                <i class="fa fa-check"></i> <b>4.</b> Containers
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="microServices.html">
            
            <a href="./microServices.html">
                <i class="fa fa-check"></i> <b>4.1.</b> Micro Services
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="javaContainer.html">
            
            <a href="./javaContainer.html">
                <i class="fa fa-check"></i> <b>4.2.</b> Java Container
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="springBootContainer.html">
            
            <a href="./springBootContainer.html">
                <i class="fa fa-check"></i> <b>4.3.</b> Spring Boot Container
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="docker.html">
            
            <a href="./docker.html">
                <i class="fa fa-check"></i> <b>4.4.</b> Docker
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="sshContainers.html">
            
            <a href="./sshContainers.html">
                <i class="fa fa-check"></i> <b>4.5.</b> SSH Containers
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="cloudContainers.html">
            
            <a href="./cloudContainers.html">
                <i class="fa fa-check"></i> <b>4.6.</b> Cloud Containers
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="gateway.html">
            
            <a href="./gateway.html">
                <i class="fa fa-check"></i> <b>5.</b> Additional Features
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="gateway.html">
            
            <a href="./gateway.html">
                <i class="fa fa-check"></i> <b>5.1.</b> Gateway
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="requirements.html">
            
            <a href="./requirements.html">
                <i class="fa fa-check"></i> <b>5.2.</b> Requirements
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="rollingUpgrade.html">
            
            <a href="./rollingUpgrade.html">
                <i class="fa fa-check"></i> <b>5.3.</b> Rolling Upgrade
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="offlineRepo.html">
            
            <a href="./offlineRepo.html">
                <i class="fa fa-check"></i> <b>5.4.</b> Offline Repository
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="partition.html">
            
            <a href="./partition.html">
                <i class="fa fa-check"></i> <b>5.5.</b> Partition
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="processManager.html">
            
            <a href="./processManager.html">
                <i class="fa fa-check"></i> <b>5.6.</b> Process Manager
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="security.html">
            
            <a href="./security.html">
                <i class="fa fa-check"></i> <b>5.7.</b> Security
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="propertyResolver.html">
            
            <a href="./propertyResolver.html">
                <i class="fa fa-check"></i> <b>5.8.</b> Property Resolver
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.9" data-path="urlHandlers.html">
            
            <a href="./urlHandlers.html">
                <i class="fa fa-check"></i> <b>5.9.</b> URL Handlers
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" data-path="brokerTopology.html">
            
            <a href="./brokerTopology.html">
                <i class="fa fa-check"></i> <b>6.</b> Using Apache ActiveMQ
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1" data-path="brokerTopology.html">
            
            <a href="./brokerTopology.html">
                <i class="fa fa-check"></i> <b>6.1.</b> Broker Topology
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="brokerClients.html">
            
            <a href="./brokerClients.html">
                <i class="fa fa-check"></i> <b>6.2.</b> Broker Clients
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="7" data-path="dataTransform.html">
            
            <a href="./dataTransform.html">
                <i class="fa fa-check"></i> <b>7.</b> Using Apache Camel
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1" data-path="dataTransform.html">
            
            <a href="./dataTransform.html">
                <i class="fa fa-check"></i> <b>7.1.</b> Data Transform
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.2" >
            
            <span><b>7.2.</b> Endpoints</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.2.1" data-path="camelEndpointAmq.html">
            
            <a href="./camelEndpointAmq.html">
                <i class="fa fa-check"></i> <b>7.2.1.</b> amq
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.2.2" data-path="camelEndpointFabric.html">
            
            <a href="./camelEndpointFabric.html">
                <i class="fa fa-check"></i> <b>7.2.2.</b> fabric
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.2.3" data-path="camelEndpointMaster.html">
            
            <a href="./camelEndpointMaster.html">
                <i class="fa fa-check"></i> <b>7.2.3.</b> master
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8" data-path="cxfFabric.html">
            
            <a href="./cxfFabric.html">
                <i class="fa fa-check"></i> <b>8.</b> Using Apache CXF
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1" data-path="cxfFabric.html">
            
            <a href="./cxfFabric.html">
                <i class="fa fa-check"></i> <b>8.1.</b> CXF Fabric
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 65.625%;min-width: 62.5%;"></div>
    </div>
    <div class="chapters">
    
        <a href="./index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="./overview.html" title="Overview" class="chapter done " data-progress="1.1" style="left: 3.125%;"></a>
    
        <a href="./getStarted.html" title="Get Started" class="chapter done " data-progress="1.2" style="left: 6.25%;"></a>
    
        <a href="./environmentVariables.html" title="Environment Variables" class="chapter done " data-progress="1.3" style="left: 9.375%;"></a>
    
        <a href="./developer.html" title="Developer Workflow" class="chapter done " data-progress="2.1" style="left: 12.5%;"></a>
    
        <a href="./mavenPlugin.html" title="Maven Plugin" class="chapter done " data-progress="2.2" style="left: 15.625%;"></a>
    
        <a href="./registry.html" title="Registry" class="chapter done " data-progress="3.1" style="left: 18.75%;"></a>
    
        <a href="./profiles.html" title="Profiles" class="chapter done " data-progress="3.2" style="left: 21.875%;"></a>
    
        <a href="./agent.html" title="Agent" class="chapter done " data-progress="3.3" style="left: 25%;"></a>
    
        <a href="./git.html" title="Git" class="chapter done " data-progress="3.4" style="left: 28.125%;"></a>
    
        <a href="./mavenProxy.html" title="Maven Proxy" class="chapter done " data-progress="3.5" style="left: 31.25%;"></a>
    
        <a href="./microServices.html" title="Micro Services" class="chapter done " data-progress="4.1" style="left: 34.375%;"></a>
    
        <a href="./javaContainer.html" title="Java Container" class="chapter done " data-progress="4.2" style="left: 37.5%;"></a>
    
        <a href="./springBootContainer.html" title="Spring Boot Container" class="chapter done " data-progress="4.3" style="left: 40.625%;"></a>
    
        <a href="./docker.html" title="Docker" class="chapter done " data-progress="4.4" style="left: 43.75%;"></a>
    
        <a href="./sshContainers.html" title="SSH Containers" class="chapter done " data-progress="4.5" style="left: 46.875%;"></a>
    
        <a href="./cloudContainers.html" title="Cloud Containers" class="chapter done " data-progress="4.6" style="left: 50%;"></a>
    
        <a href="./gateway.html" title="Gateway" class="chapter done " data-progress="5.1" style="left: 53.125%;"></a>
    
        <a href="./requirements.html" title="Requirements" class="chapter done " data-progress="5.2" style="left: 56.25%;"></a>
    
        <a href="./rollingUpgrade.html" title="Rolling Upgrade" class="chapter done " data-progress="5.3" style="left: 59.375%;"></a>
    
        <a href="./offlineRepo.html" title="Offline Repository" class="chapter done " data-progress="5.4" style="left: 62.5%;"></a>
    
        <a href="./partition.html" title="Partition" class="chapter done " data-progress="5.5" style="left: 65.625%;"></a>
    
        <a href="./processManager.html" title="Process Manager" class="chapter  " data-progress="5.6" style="left: 68.75%;"></a>
    
        <a href="./security.html" title="Security" class="chapter  " data-progress="5.7" style="left: 71.875%;"></a>
    
        <a href="./propertyResolver.html" title="Property Resolver" class="chapter  " data-progress="5.8" style="left: 75%;"></a>
    
        <a href="./urlHandlers.html" title="URL Handlers" class="chapter  " data-progress="5.9" style="left: 78.125%;"></a>
    
        <a href="./brokerTopology.html" title="Broker Topology" class="chapter  " data-progress="6.1" style="left: 81.25%;"></a>
    
        <a href="./brokerClients.html" title="Broker Clients" class="chapter  " data-progress="6.2" style="left: 84.375%;"></a>
    
        <a href="./dataTransform.html" title="Data Transform" class="chapter  " data-progress="7.1" style="left: 87.5%;"></a>
    
        <a href="./camelEndpointAmq.html" title="amq" class="chapter  " data-progress="7.2.1" style="left: 90.625%;"></a>
    
        <a href="./camelEndpointFabric.html" title="fabric" class="chapter  " data-progress="7.2.2" style="left: 93.75%;"></a>
    
        <a href="./camelEndpointMaster.html" title="master" class="chapter  " data-progress="7.2.3" style="left: 96.875%;"></a>
    
        <a href="./cxfFabric.html" title="CXF Fabric" class="chapter  " data-progress="8.1" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_23">
                    
                        <h2 id="partition">Partition</h2>
<p>The Fabric8 Partition provides the ability of defining a task, that can be &quot;partitioned&quot; and distributed to fabric containers.
Each task can be associated with multiple work items (aka partitions) and those are distributed to the containers.</p>
<p>Some examples that make use of this functionality are:
i) Distribute raw camel routes in blueprint xml format to containers (see example-camel-partition.routes).
ii) Generate camel routes based on a template + json parameters and distribute them to containers (see example-camel-partition.json).</p>
<h3 id="terminology">Terminology</h3>
<ul>
<li><strong>Task</strong> A unit of work that can be split into individual work items that can be distributed to multiple containers.</li>
<li><strong>Balancing Policy</strong> A configured policy that specifies the way that the work items will be distributed to containers (currently only supported implementation is even distribution).</li>
<li><strong>Work Item</strong> A portion of the work that is distributed to the container.</li>
<li><strong>Work Item Repository</strong> A repository that contains work items. There are currently two implementations: i) ZooKeeper based and ii) Profile based.</li>
<li><strong>Task Coordiantor</strong> Joins a master election process. The master listens to the configured <strong>Work Item Repository</strong> for changes and distributes items according to the configured <strong>Balancing Policy</strong>.</li>
<li><strong>Task Handler</strong> A component that handles assignment of work items. The task handler passes the items assigned/removed to the <strong>Worker</strong> (see below).</li>
<li><strong>Worker</strong> An interface that describes how the container should handle when added/removed a work items. The worker type is configurable for each task.</li>
</ul>
<h2 id="what-does-a-work-item-look-like-">What does a work item look like?</h2>
<p>A work item can be anything, that we want to distributed to containers. It can be a any file like a jar, an xml file, a json file.
As long as there is a worker that can handle the work item, the work item can be anything you like.</p>
<p>Inside Fabric8 the work item is represented by a unique id, by a location and a Map object <em>(if work item is a json file, it will get parsed into the map)</em>.</p>
<p>In the example-camel-partition.routes the work items are raw xml files containing camel blueprint routes.
In the example-camel-partition.json the work items are json blobs, which are used to render camel routes from a template.</p>
<h2 id="creating-tasks">Creating Tasks</h2>
<p>A task can be defined by providing a configuration pid that uses teh io.fabric8.partition factoryPid.</p>
<h3 id="required-configuration">Required configuration</h3>
<ul>
<li><strong>id</strong> A unique id that specifies the task.</li>
<li><strong>balancingPolicy.target</strong> The name of the balancing policy (e.g. even). It is passed as an LDAP filter (e.g. (type=even)).</li>
<li><strong>workItemRepositoryFactory.target</strong> The type of the work item repository (supported values: zookeeper, profile). It is passed as an LDAP filter (e.g. (type=zokeeper) or (type=profile)).</li>
<li><strong>workItemPath</strong> The path that contains the work items.</li>
<li><strong>worker.target</strong> The type of worker to use. It is passed as an LDAP filter (e.g. (type=profile-template)).</li>
</ul>
<p>Note, that the balancing policy, the work item repository and the worker type are looked up from the Service Registry, using the specified value as a filter.</p>
<h2 id="using-fabric-partition-to-distribute-dynamic-profiles">Using fabric-partition to distribute dynamic profiles</h2>
<p>As mentioned above, fabric-partition module provides a Worker implementation that creates profiles &quot;on the fly&quot; based on the assigned work items and a profile.
There are two example profiles that demonstrate this feature:</p>
<h3 id="example-camel-partition-routes">example-camel-partition.routes</h3>
<p>This profile can be used to automatically distribute raw xml routes to containers that are assigned this profile.
The structure of the profile looks like:</p>
<pre><code>example-camel-partition.routes
    |
    +-routes    (work item path)
    |   |
    |   +-&gt;route1.xml (example work item)
    |   +-&gt;route2.xml
    |   +-&gt;route3.xml
    |   +-&gt;route4.xml
    |
    +-io.fabric8.agent.properties
    +-io.fabric8.partition-example.properties (task configuration)
</code></pre><p>The io.fabric8.partition-example.properties defines a task as follows:</p>
<pre><code>id=example
workItemRepositoryFactory.target=(type=git)
workItemPath=profile:example-camel-partition.routes/routes
balancingPolicy.target=(type=even)
worker.target=(type=profile-template)
templateProfile=example-camel-template.routes
</code></pre><p>In the configuration above the workItemPath represents the location where the work items (raw xml files) are stored. The workerType represents the type of Worker to use (in this case its the profile template worker). Last the templateProfile which is a configuration parameter specific to the worker, is the template profile to be used.
This profile also contains a folder, with 4 simple camel routes (these are the actual work items).</p>
<p>The configuration specifies a template profile which is example-camel-template.routes:</p>
<pre><code> example-camel-template.routes
     |
     +-io.fabric8.agent.properties.mvel
</code></pre><p> this profile just contains a simple template configuration that just defines that for each work item should be deployed as a raw blueprint xml file (as specified by io.fabric8.agent.properties.mvel):</p>
<pre><code>bundle.profile.camel-@{item.id}=blueprint:profile:@{item.location}
</code></pre><h3 id="example-camel-partition-json">example-camel-partition.json</h3>
<p>Similar to the previous example, this profile will distribute camel routes to containers. In this case the camel routes are not static, but are rendered using a template + parameters.
The parameters are in the json format. These json blobs will play the role of the work item. Each containers will be assigned one or more json blobs and for each assigned json, the template will be rendered and deployed to the container</p>
<p>The structure of the profile looks like:</p>
<pre><code>example-camel-partition.json
    |
    +-items    (work item path)
    |   |
    |   +-&gt;1 (example work item. It&#39;s a simple json that looks like: {inUri : direct:start1}
    |   +-&gt;2 {inUri : direct:start2}
    |   +-&gt;3 {inUri : direct:start3}
    |   +-&gt;4 {inUri : direct:start4}
    |
    +-io.fabric8.agent.properties
    +-io.fabric8.partition-example.properties (task configuration)
</code></pre><p>The io.fabric8.partition-example.properties defines a task as follows:</p>
<pre><code>id=example
workItemRepositoryFactory.target=(type=git)
workItemPath=profile:example-camel-partition.json/items
balancingPolicy.target=(type=even)
worker.target=(type=profile-template)
templateProfile=example-camel-template.json
</code></pre><p>In the configuration above the workItemPath represents the location where the work items (json files) are stored. The workerType represents the type of Worker to use (in this case its the profile template worker). Last the templateProfile which is a configuration parameter specific to the worker, is the template profile to be used.
This profile also contains a folder, with 4 simple camel routes (these are the actual work items).</p>
<p>The configuration specifies a template profile which is example-camel-template.json:</p>
<pre><code> example-camel-template.json
     |
     +-camel__item.data.it__.xml.mvel
     +-io.fabric8.agent.properties.mvel
</code></pre><p>The camel<strong>item.data.it</strong>.xml.mvel is the route template:</p>
<pre><code>    &lt;camelContext id=&quot;camel-@{item.id}&quot; trace=&quot;false&quot; xmlns=&quot;http://camel.apache.org/schema/blueprint&quot;&gt;
        &lt;route id=&quot;route-@{item.id}&quot;&gt;
            &lt;from uri=&quot;@{item.data.inUri}&quot; /&gt;  &lt;!-- Everything under item.data are pulled in from the json blob --&gt;
            &lt;to uri=&quot;log:requests&quot; /&gt;
        &lt;/route&gt;
    &lt;/camelContext&gt;
</code></pre><p>This template is rendered into a plain xml and is stored inside the profile using camel<item.id>.xml as a file name.
The rendered route is then deployed as the io.fabric8.agent.properties.mvel specifies:</p>
<pre><code>bundle.profile.camel-@{item.id}=blueprint:profile:camel@{item.id}.xml
</code></pre><p><strong>The Template Profile Worker</strong>
In both of the examples above we used the template profile worker. The template profile workers role is to look up the template profile and render it using the assigned work items.
The worker is using mvel templates, so it goes through the template profile resources and for each resource that is an mvel template (identified by its extension) it renders the template and stores it to a new profile that is unique per task and container.
The name of the profile will always be <template profile name>.<container name>. Non mvel resources will be just copied as is to the new profile.
Last the new profile is assigned to the container. If the rendered profile is empty the profile will get deleted and removed from the container.</p>
<p><strong>Other Template Profiles</strong>
You could use your own template profiles to do things like distributing features to containers:</p>
<pre><code>template
|
+----------&gt; io.fabric8.agent.properties.mvel
</code></pre><p>The io.fabric8.agent.properties.mvel could look like this:</p>
<pre><code>feature.@{name}=@{name}
</code></pre><p>So give a partition item that contains the following json:</p>
<pre><code>{ &quot;name&quot; : &quot;cool-feature&quot; }
</code></pre><p>The worker will render the file as follows:</p>
<pre><code>feature.cool-feature=cool-feature
</code></pre><p>Then it will create a new profile and assign it to local container.</p>
<p><em>Note:</em> If you need to also have the resource names under the profile template, you can use in the file name a placeholder surrounded by double underscores, e.g: camel-<strong>id</strong>.xml.</p>
<h2 id="the-profile-work-item-repository">The profile work item repository</h2>
<p>The examples above made use of the Profile Work Item Repository. This repository can lookup for work items to distribute under the profile, using the Profile URL Handler as a work item path.
You can then add / remove work items, by adding or removing resources from the profile path.</p>
<h2 id="the-zookeeper-work-item-repository">The zookeeper work item repository</h2>
<p>An alternative to the profile work item repository, is the zookeeper work item repository. When using it, you specify a zookeeper path that will contain work items.
You can then add/remove znodes to that path, that will contain the work items. For example if you specify the workItemPath /fabric/partition/example. You can add workitems using the shell like:</p>
<pre><code>zk:create /fabric/partition/example/1 &quot;{ \&quot;inUri\&quot; : \&quot;direct:in1\&quot; }&quot;
zk:create /fabric/partition/example/2 &quot;{ \&quot;inUri\&quot; : \&quot;direct:in2\&quot; }&quot;
</code></pre><h2 id="implementing-custom-workers">Implementing custom Workers</h2>
<p>In most cases the user will want to implement his own workers. Implementing one is as trivial as implementing the following methods.</p>
<pre><code>String getType();

void assign(TaskContext context, Set&lt;WorkItem&gt; items);

void release(TaskContext context, Set&lt;WorkItem&gt; items);
</code></pre><p>The getType() method should return a string, which can be used for looking up the listener (used in the workerType property).
The assign/release methods can be used to implement the behavior of the worker when items are added/removed.
The argument context represents the task and it encapsulates the task configuration.
The items argument is a representation of the items, which contains a unique identifier for the item, the location of the item and a java.util.Map which can contain additional data if work item is in json format.</p>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="./offlineRepo.html" class="navigation navigation-prev " aria-label="Previous page: Offline Repository"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./processManager.html" class="navigation navigation-next " aria-label="Next page: Process Manager"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-javascript.js"></script>
        <script src="gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="gitbook/app.js"></script>
        

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
