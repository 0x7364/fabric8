<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>CDI | Fabric8 Documentation</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.0.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="./testing.html" />
    
    
    <link rel="prev" href="./javaLibraries.html" />
    

        
    </head>
    <body>
        
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-anchors/plugin.css">
        
    
    

        
    <div class="book" data-level="3.3" data-basepath="." data-revision="Wed May 06 2015 12:47:46 GMT+0000 (UTC)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="overview.html">
            
                
                    <a href="./overview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Overview
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="pods.html">
            
                
                    <a href="./pods.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Pods
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="replicationControllers.html">
            
                
                    <a href="./replicationControllers.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Replication Controllers
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="labels.html">
            
                
                    <a href="./labels.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Labels
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="services.html">
            
                
                    <a href="./services.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Services
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="apps.html">
            
                
                    <a href="./apps.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Apps
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="appzip.html">
            
                
                    <a href="./appzip.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                        App Zip
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="environments.html">
            
                
                    <a href="./environments.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                        Environments
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="builds.html">
            
                
                    <a href="./builds.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                        Builds
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="getStarted.html">
            
                
                    <a href="./getStarted.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Getting Started
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="getStartedOpenShift.html">
            
                
                    <a href="./getStartedOpenShift.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Using OpenShift V3
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="openShiftDocker.html">
            
                
                    <a href="./openShiftDocker.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.1.</b>
                        
                        Docker
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="openShiftVagrant.html">
            
                
                    <a href="./openShiftVagrant.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.2.</b>
                        
                        Vagrant
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="openShiftInstall.html">
            
                
                    <a href="./openShiftInstall.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.3.</b>
                        
                        Install Natively
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="getStartedJube.html">
            
                
                    <a href="./getStartedJube.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Using Jube
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="jubeRunQuickstart.html">
            
                
                    <a href="./jubeRunQuickstart.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.1.</b>
                        
                        Running a quickstart on Jube
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="jubeAddQuickstartApp.html">
            
                
                    <a href="./jubeAddQuickstartApp.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.2.</b>
                        
                        Add a quickstart to the App Library
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="example.html">
            
                
                    <a href="./example.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Deploy an example
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="tools.html">
            
                
                    <a href="./tools.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Tools
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="mavenPlugin.html">
            
                
                    <a href="./mavenPlugin.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Maven Plugin
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="javaLibraries.html">
            
                
                    <a href="./javaLibraries.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Java Libraries
                    </a>
                
            
            
        </li>
    
        <li class="chapter active" data-level="3.3" data-path="cdi.html">
            
                
                    <a href="./cdi.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        CDI
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="testing.html">
            
                
                    <a href="./testing.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Testing
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="quickstarts.html">
            
                
                    <a href="./quickstarts.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                        QuickStarts
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="forge.html">
            
                
                    <a href="./forge.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                        Forge Addons
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="fabric8Apps.html">
            
                
                    <a href="./fabric8Apps.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Fabric8 Apps
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="console.html">
            
                
                    <a href="./console.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Console
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="logging.html">
            
                
                    <a href="./logging.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Logging
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="metrics.html">
            
                
                    <a href="./metrics.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                        Metrics
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="chat.html">
            
                
                    <a href="./chat.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                        Chat
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="apiRegistry.html">
            
                
                    <a href="./apiRegistry.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                        API Registry
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="appLibrary.html">
            
                
                    <a href="./appLibrary.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.6.</b>
                        
                        App Library
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="fabric8MQ.html">
            
                
                    <a href="./fabric8MQ.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.7.</b>
                        
                        MQ
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="fabric8MQAutoScaler.html">
            
                
                    <a href="./fabric8MQAutoScaler.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.8.</b>
                        
                        MQ AutoScaler
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="v2-changes.html">
            
                
                    <a href="./v2-changes.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Changes from V1
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="jube.html">
            
                
                    <a href="./jube.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Jube
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="FAQ.html">
            
                
                    <a href="./FAQ.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        FAQ
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1" data-path="faqGeneral.html">
            
                
                    <a href="./faqGeneral.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.1.</b>
                        
                        General Questions
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >Fabric8 Documentation</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h2 id="cdi"><a name="cdi" class="plugin-anchor" href="#cdi"><span class="fa fa-link"></span></a>CDI</h2>
<p>Fabric8 provides a CDI extension which is meant to make developing CDI apps for kubernetes easier.</p>
<p>Using CDI it is possible to:</p>
<ul>
<li>Inject a fabric8 managed kubernetes client.</li>
<li>Inject URL to kubernetes service using the @Service.</li>
<li>Inject a client for a kubernetes service using the @Service and @Factory.</li>
<li>Inject configuration provided as Environamnt Variables.</li>
<li>Create scopes of configuration using the @Configuration.</li>
</ul>
<p>The CDI extension works for application that live both inside and outside of kubernetes. So it can be used safely in kubernetes and hybrid deployments for easier consumption of kubernetes managed services.</p>
<h3 id="the-service-annotation"><a name="the-service-annotation" class="plugin-anchor" href="#the-service-annotation"><span class="fa fa-link"></span></a>The @Service annotation</h3>
<p>In kubernetes, each service has a host and a port and they are passed to container as environment variable. Containers that live inside Kubernetes
can lookup for services using their environment variables. Application that live outside of kubernetes need to use the kubernetes API in order to perform lookups.</p>
<p>The fabric8 extension provides a unified approach in looking up for service coordinates. It provides the @Service qualifier which can be used to inject the coordinates as a String or as a URL by just referring to the id of the service.</p>
<pre><code>@Inject
@Service(&quot;my-service&quot;)
private String service.
</code></pre><h3 id="running-inside-and-outside-of-kubernetes"><a name="running-inside-and-outside-of-kubernetes" class="plugin-anchor" href="#running-inside-and-outside-of-kubernetes"><span class="fa fa-link"></span></a>Running inside and outside of Kubernetes</h3>
<p>Under the covers the code will default to using the <strong>MY_SERVICE_SERVICE_HOST</strong> and <strong>MY_SERVICE_SERVICE_PORT</strong> environment variables exposed by <a href="services.html">kubernetes services</a> to discover the IP and port to use to connect to the service. Kubernetes sets those environment variables automatically when your pod is run inside Kubernetes.</p>
<p>If your Java code is running outside of Kubernetes then @Service will use the environment variable <strong>KUBERNETES_MASTER</strong> to connect to the kubernetes REST API and then use that to discover where the services are. This lets you run the same Java code in a test, in your IDE and inside kubernetes.</p>
<h3 id="creating-custom-objects"><a name="creating-custom-objects" class="plugin-anchor" href="#creating-custom-objects"><span class="fa fa-link"></span></a>Creating custom objects</h3>
<p>In most of the cases the user will create a client so that it can consume the service. This can be easily done by providing a factory.</p>
<pre><code>@Produces
@Service
public MyClient create(InjectionPoint ip) {
    Service service = ip.getAnnotated().getAnnotation(Service.class);
    String url = Services.toServiceUrl(service.getId(), service.getProtocol());
    return new MyClient(url);
}
</code></pre><h3 id="using-factories"><a name="using-factories" class="plugin-anchor" href="#using-factories"><span class="fa fa-link"></span></a>Using Factories</h3>
<p>The example above is something that works but it does require boilerplate (and other limitation which are discussed below).
To simplify the code Fabric8 provides the @Factory annotation.</p>
<pre><code>   @Factory
   @Service
   public MyClient create(@Service String url) {
       return new MyClient(url);
   }
</code></pre><h3 id="integration-with-apache-deltaspike"><a name="integration-with-apache-deltaspike" class="plugin-anchor" href="#integration-with-apache-deltaspike"><span class="fa fa-link"></span></a>Integration with Apache Deltaspike</h3>
<p>In kubernetes its quite common to pass around configuration via Environment Variables. Outside of kubernetes java developers often use System properties, property files and what not.
DeltaSpike provides an awesome extension which works great along with the fabric8 extension that allows the user to inject configuration form various sources:</p>
<ul>
<li>System Properties</li>
<li>Environment Variables</li>
<li>JNDI values</li>
<li>Property Files</li>
</ul>
<h4 id="the-configproperty-annotation"><a name="the-configproperty-annotation" class="plugin-anchor" href="#the-configproperty-annotation"><span class="fa fa-link"></span></a>The @ConfigProperty annotation</h4>
<p>Using the @ConfigProperty annotation the user can inject configuration from the sources mentioned above. The lookup is performed in the exact same order provided above.
It&apos;s use is pretty straight-forward:</p>
<h4 id="putting-it-all-together"><a name="putting-it-all-together" class="plugin-anchor" href="#putting-it-all-together"><span class="fa fa-link"></span></a>Putting it all together</h4>
<p>In most case, when we need to consume a service we need both the coordinates of the service and static configuration data, like thread pool configuration, maximum number of connections etc.
So it makes sense when we create the &quot;factory&quot; for our client, to also inject configuration. For example:</p>
<pre><code>@Inject
@ConfigProperty(name=&quot;CONNECTION_TIMEOUT&quot;, defaultValue=&quot;10000L&quot;)
private Long timeout; 

@Produces
@Service
public MyClient create(@Service url) {
    return new MyClient(url, timeout);
}
</code></pre><p>But what happens if we need  to create multiple instances of MyClient each configured differently?</p>
<h4 id="the-configuration-annotation"><a name="the-configuration-annotation" class="plugin-anchor" href="#the-configuration-annotation"><span class="fa fa-link"></span></a>The @Configuration annotation</h4>
<p>The configuration annotation allows you to group a set of configuration properties together as part of a bean and instantiate it with different configuration values, depending the context.</p>
<p>For example let&apos;s assume that <strong>MyClient</strong> which has been used in the previous examples, requires a timeout and a pool size for its configuration. And we need to configure multiple instances of MyClient.
The configuration of MyClient can be encapsulated like this:</p>
<pre><code>public class MyConfig {
    private final Integer poolSize;
    private final Long timeout;
}
</code></pre><p>The obvious way would be to create 2 classes for MyConfig each using a different set of annotations. The worst part is that then we would also need to create 2 instances of @Produces each consuming a different set of configuration. Which becomes really painful even for a simple example like this.</p>
<p>The alternative approach is to use the @Configuration annotation and a simple convention: &quot;For all configuration sets, keys are named the same and use a descriminator prefix&quot;. This would allow use to use a single MyConfig class and only specifiy the <strong>descriminator</strong> where we need to.</p>
<pre><code> public class MyConfig {
     @Inject
     @ConfigProperty(name=&quot;POOL_SIZE&quot;, defaultValue=&quot;10&quot;)         
     private final Integer poolSize;

     @Inject
     @ConfigProperty(name=&quot;CONNECTION_TIMEOUT&quot;, defaultValue=&quot;10000L&quot;)
     private final Long timeout;
 }
</code></pre><p>The discriminator only needs to be specified at the point where configuration is consumed.</p>
<pre><code>    @Inject
    @Configuration(&quot;SERVICE_1&quot;)
    private MyConfig cfg1;

    @Inject
    @Configuration(&quot;SERVICE_2&quot;)
    private MyConfig cfg2;
</code></pre><h4 id="combining-factory-service-and-configuration-annotations"><a name="combining-factory-service-and-configuration-annotations" class="plugin-anchor" href="#combining-factory-service-and-configuration-annotations"><span class="fa fa-link"></span></a>Combining @Factory, @Service and @Configuration annotations</h4>
<p>To further reduce the amount of boilerplate one could use all of the annotations to create generic factories that accepts as parameters service urls and configuration.</p>
<pre><code>public class MyFactory {
    @Factory
    @Service
    MyClient create(@Service String url, @Configuration MyConfig cfg) {
        return MyClient(url, cfg);  
    }
}
</code></pre><p>The you can directly inject the client:</p>
<pre><code>    @Inject
    @Service(&quot;SERVICE_1&quot;)
    private MyClient cl1;

    @Inject
    @Service(&quot;SERVICE_2&quot;)
    private MyClient cl2;        
</code></pre><p>In this approach the benefit is double as both the configuration and the service url are not needed to be specified in the factory but just to the place where the client is consumed. That makes the factory reusable and reduces the amount of code needed.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./javaLibraries.html" class="navigation navigation-prev " aria-label="Previous page: Java Libraries"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./testing.html" class="navigation navigation-next " aria-label="Next page: Testing"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
